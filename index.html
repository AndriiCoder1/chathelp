<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatHelp</title>
</head>
<body>
    <h1>ChatHelp</h1>
    <div id="datetime" style="font-size: 18px; margin-bottom: 10px;"></div>
    <button id="theme-toggle">L / D</button>
    <div id="chat-log"></div>
    <textarea id="message-input" placeholder="Eingabe nachricht..."></textarea>
    <button onclick="sendMessage()">Отправить</button>
    <p id="response"></p>
    <audio id="audioPlayer" controls style="display:none;"></audio>

    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f7fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100vh;
        margin: 0;
        transition: background-color 0.3s, color 0.3s;
      }
  
      h1 {
        color: #333;
        margin-top: 20px;
        transition: color 0.3s;
      }
  
      #chat-log {
        width: 100%;
        max-width: 600px;
        height: calc(100vh - 160px);
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #fff;
        margin-bottom: 20px;
        transition: background-color 0.3s, border-color 0.3s;
      }
  
      #message-input {
        border: 3px solid green;
        width: 100%;
        min-height: 40px;
        padding: 10px;
        font-size: 18px;
        margin-right: 10px;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.4s, background-color 0.4s;
        resize: none;
        overflow: hidden;
      }
  
      .dark-theme #message-input {
        background-color: #343541;
        border: 1px solid #444;
        color: #e8e8e8;
      }
  
      #message-input:placeholder-shown {
        border-color: green;
      }
  
      #message-input:not(:placeholder-shown) {
        border-color: orangered;
      }
  
      #message-input:focus {
        border-color: #4285f4;
      }
  
      #send-button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
  
      #send-button:hover {
        background-color: #0056b3;
      }
  
      .input-container {
        width: 100%;
        max-width: 600px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
  
      #theme-toggle {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        z-index: 1000;
      }
  
      @media (max-width: 768px) {
        #theme-toggle {
          font-size: 12px;
          padding: 5px 8px;
        }
      }
  
      .dark-theme {
        background-color: #202123;
        color: #e8e8e8;
      }
  
      .dark-theme #chat-log {
        background-color: #343541;
        border-color: #444;
      }
  
      .dark-theme #chat-log p {
        color: #e8e8e8;
      }
  
      .dark-theme .bot-message {
        color: #b0bec5;
      }
  
      .dark-theme #send-button {
        background-color: #3c3f42;
        color: #e8e8e8;
      }
  
      .dark-theme #send-button:hover {
        background-color: #4a4e51;
      }
  
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
      }
  
    </style>
    
    <script>
        const socket = io();
        const themeToggleButton = document.getElementById('theme-toggle');
        const bodyElement = document.body;

        let recognition = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let voices = [];
    

        function sendMessage() {
            const input = document.getElementById("message-input");
            const message = input.value.trim();
            if (!message) return;

            socket.emit("message", message);
            input.value = "";
        }

        socket.on("message", (data) => {
            if (data.text) {
                document.getElementById("response").innerText = data.text;
            }
            if (data.audioUrl) {
                const player = document.getElementById("audioPlayer");
                player.src = data.audioUrl;
                player.style.display = "block";
                player.play();
            }
        });

         // Инициализация синтеза речи
  function initSpeechSynthesis() {
  if (!window.speechSynthesis) {
    console.warn('Синтез речи не поддерживается');
    ttsToggle.disabled = true;
    return;
  }

  // Загрузка голосов
  speechSynthesis.onvoiceschanged = () => {
  voices = speechSynthesis.getVoices();
  voices.forEach(voice => {
      const option = document.createElement('option');
      option.value = voice.name;
      option.textContent = `${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(option);
    });
  };
}

 

  // Функция для озвучивания текста
  function speak(text) {
  if (!isTTSEnabled || !text) return;

  const utterance = new SpeechSynthesisUtterance(text);
  const selectedVoice = voices.find(v => v.name === voiceSelect.value);
  
  // Настройки голоса
  utterance.voice = selectedVoice || voices.find(v => v.lang === 'ru-RU');
  utterance.rate = 1.0; // Скорость (0.1-2)
  utterance.pitch = 1.0; // Тон (0-2)
  utterance.volume = 1.0; // Громкость (0-1)

  speechSynthesis.speak(utterance);
}

    // Инициализация при загрузке
    initSpeechSynthesis();

    // Инициализация аудиозаписи
    async function startAudioRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (e) => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await sendAudioToServer(audioBlob);
          audioChunks = [];
        };

        mediaRecorder.start();
        isRecording = true;
        startRecordingTimer();
      } catch (error) {
        console.error('Ошибка доступа к микрофону:', error);
        alert('Разрешите доступ к микрофону в настройках браузера!');
      }
    }

    // Отправка аудио на сервер
    async function sendAudioToServer(audioBlob) {
      try {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        const response = await fetch('/process-audio', {
          method: 'POST',
          body: formData
        });
        
        const { transcription } = await response.json();
        document.getElementById('message-input').value = transcription;
        sendMessage();
      } catch (error) {
        console.error('Ошибка отправки аудио:', error);
      }
    }

    

    

    // Обновленная инициализация распознавания речи
    function initSpeechRecognition() {
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!window.SpeechRecognition) {
        voiceButton.style.display = 'none';
        console.warn('Голосовой ввод не поддерживается');
        return;
      }

      recognition = new window.SpeechRecognition();
      recognition.lang = 'ru-RU'; // Исправлено на русский язык
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = () => {
        voiceButton.classList.add('recording');
        startAudioRecording();
      };

      recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('');
        document.getElementById('message-input').value = transcript;
      };

      recognition.onerror = (event) => {
        console.error('Ошибка распознавания:', event.error);
        stopRecording();
      };

      recognition.onend = () => {
        stopRecording();
      };
    }

    // Обработчик кнопки голосового ввода
    voiceButton.addEventListener('click', () => {
      if (!isRecording) {
        if (recognition) recognition.start();
      } else {
        stopRecording();
      }
    });

    // Остальной код без изменений
    function addMessageToChat(message, isBot = false) {
      const chatLog = document.getElementById('chat-log');
      const messageElement = document.createElement('p');
      messageElement.textContent = message;

      if (isBot) {
        messageElement.classList.add('bot-message');
      }

      chatLog.appendChild(messageElement);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    socket.on('connect', () => {
      console.log('Подключено к серверу');
    });

    socket.on('disconnect', () => {
      console.log('Отключено от сервера');
    });

    socket.on('message', (message) => {
      console.log('Получено сообщение:', message);
      addMessageToChat(message, true);
    });

    socket.on('message', (message) => {
      addMessageToHistory(message, true);
      speak(message); // Озвучиваем ответ бота
    });

    document.getElementById('send-button').addEventListener('click', sendMessage);
    
    document.getElementById('message-input').addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    function sendMessage() {
      const message = document.getElementById('message-input').value.trim();
      if (message) {
        addMessageToChat(message);
        socket.emit('message', message);
        document.getElementById('message-input').value = '';
      }
    }

    // Остальные функции без изменений
    function toggleTheme() {
      const isDarkMode = bodyElement.classList.toggle('dark-theme');
      themeToggleButton.textContent = isDarkMode ? 'Light' : 'Dark';
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    themeToggleButton.addEventListener('click', toggleTheme);

    if (localStorage.getItem('theme') === 'dark') {
      bodyElement.classList.add('dark-theme');
      themeToggleButton.textContent = 'Light';
    }

    function updateDateTime() {
      const datetimeElement = document.getElementById('datetime');
      const now = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      };
      datetimeElement.textContent = now.toLocaleDateString('de-DE', options);
    }

    // Инициализация при загрузке
    initSpeechRecognition();
    setInterval(updateDateTime, 1000);
    updateDateTime();
    </script>
</body>
</html>
