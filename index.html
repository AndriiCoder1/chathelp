<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat-Help</title>
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background-color: #f4f7fa; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: space-between; 
      height: 100vh; 
      margin: 0; 
      transition: background-color 0.3s, color 0.3s; 
    }

    h1 { 
      color: #333; 
      margin-top: 20px; 
      transition: color 0.3s; 
    }

    #chat-log { 
      width: 100%; 
      max-width: 600px; 
      height: calc(100vh - 160px); 
      overflow-y: auto; 
      border: 1px solid #ccc; 
      padding: 10px; 
      background-color: #fff; 
      margin-bottom: 20px; 
      transition: background-color 0.3s, border-color 0.3s; 
    }

    #message-input { 
      border: 3px solid green; 
      width: 100%; 
      min-height: 40px; 
      padding: 10px; 
      font-size: 18px; 
      margin-right: 10px; 
      border-radius: 8px; 
      outline: none; 
      transition: border-color 0.4s, background-color 0.4s; 
      resize: none; 
      overflow: hidden; 
    }

    .dark-theme #message-input { 
      background-color: #343541; 
      border: 1px solid #444; 
      color: #e8e8e8; 
    }

    #message-input:placeholder-shown { 
      border-color: green; 
    }

    #message-input:not(:placeholder-shown) { 
      border-color: orangered; 
    }

    #message-input:focus { 
      border-color: #4285f4; 
    }

    #send-button { 
      padding: 10px 20px; 
      font-size: 16px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
    }

    #send-button:hover { 
      background-color: #0056b3; 
    }
    .input-container { 
      width: 100%; 
      max-width: 600px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px; 
    }

    #theme-toggle { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      padding: 5px 10px; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 14px; 
      z-index: 1000; 
    }

    @media (max-width: 768px) { 
      #theme-toggle { 
        font-size: 12px; 
        padding: 5px 8px; 
      }
    }

    .dark-theme { 
      background-color: #202123; 
      color: #e8e8e8; 
    }

    .dark-theme #chat-log { 
      background-color: #343541; 
      border-color: #444; 
    }

    .dark-theme #chat-log p { 
      color: #e8e8e8; 
    }

    .dark-theme .bot-message { 
      color: #b0bec5; 
    }

    .dark-theme #send-button { 
      background-color: #3c3f42; 
      color: #e8e8e8; 
    }

    .dark-theme #send-button:hover { 
      background-color: #4a4e51; 
    }

    #voice-btn { 
      background-color: #28a745; 
      color: white; 
      padding: 8px; 
      border-radius: 50%; 
      cursor: pointer; 
      margin-left: 10px; 
      font-size: 20px; 
      transition: all 0.3s; 
    }

    #voice-btn:hover { 
      background-color: #218838; 
    }

    #voice-btn.recording { 
      background-color: #dc3545; 
      animation: pulse 1s infinite; 
    }

    #tts-toggle { 
      padding: 8px; 
      margin: 5px; 
      border-radius: 5px; 
      cursor: pointer; 
    }

    #voice-select { 
      padding: 6px; 
      margin-left: 10px; 
    }

    @keyframes pulse { 
      0% { transform: scale(1); } 
      50% { transform: scale(1.1); } 
      100% { transform: scale(1); }
 }

    #recording-timer { 
      position: fixed; 
      top: 70px; 
      right: 20px; 
      font-size: 24px; 
      color: #dc3545; 
      display: none; 
      background: rgba(0,0,0,0.7); 
      padding: 5px 10px; 
      border-radius: 5px; 
    }

    .dark-theme #recording-timer { 
      color: #ff6b6b; 
      background: rgba(255,255,255,0.1); 
    }

    .language-selector {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px;
      border-radius: 5px;
      z-index: 1000;
      background: white;
    }
    .dark-theme .language-selector {
      background: #444;
      color: white;
    }
  </style>
</head>
<body>

  <h1>Chat-Help</h1>
  <div id="datetime" style="font-size: 18px; margin-bottom: 10px;"></div>
  <select class="language-selector" id="languageSelect">
    <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
    <option value="en-US">English</option>
    <option value="de-DE">Deutsch</option>
  </select>
  <button id="theme-toggle">L / D</button>
  <div id="chat-log"></div>
  <div class="input-container">
    <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
    <button id="send-button">Send</button>
    <button id="voice-btn" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏">üé§</button>
  </div>
  <div id="recording-timer"></div>

  <script>
    const socket = io();
    const themeToggleButton = document.getElementById('theme-toggle');
    const bodyElement = document.body;
    const voiceButton = document.getElementById('voice-btn');
    const recordingTimer = document.getElementById('recording-timer');
    const languageSelector = document.getElementById('languageSelect');
    
    let recognition = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let currentLanguage = 'ru-RU';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      initSpeechRecognition();
      initEventListeners();
      updateDateTime();
      setInterval(updateDateTime, 1000);
      restoreTheme();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    function initSpeechRecognition() {
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!window.SpeechRecognition) {
        voiceButton.style.display = 'none';
        return;
      }

      recognition = new window.SpeechRecognition();
      recognition.lang = currentLanguage;
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = () => {
        voiceButton.classList.add('recording');
        startAudioRecording();
      };

      recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('');
        document.getElementById('message-input').value = transcript;
      };

      recognition.onerror = (event) => {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
        stopRecording();
      };

      recognition.onend = () => {
        stopRecording();
      };
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    function initEventListeners() {
      voiceButton.addEventListener('click', toggleVoiceInput);
      languageSelector.addEventListener('change', updateLanguage);
      themeToggleButton.addEventListener('click', toggleTheme);
      document.getElementById('send-button').addEventListener('click', sendMessage);
      document.getElementById('message-input').addEventListener('keydown', handleKeyDown);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
    function updateLanguage() {
      currentLanguage = languageSelector.value;
      if (recognition) {
        recognition.lang = currentLanguage;
      }
      socket.emit('set_language', currentLanguage);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    function toggleVoiceInput() {
      if (!isRecording) {
        if (recognition) recognition.start();
      } else {
        stopRecording();
      }
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function addMessageToChat(message, isBot = false) {
      const chatLog = document.getElementById('chat-log');
      const messageElement = document.createElement('p');
      messageElement.textContent = message;

      if (isBot) {
        messageElement.classList.add('bot-message');
      }

      chatLog.appendChild(messageElement);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function sendMessage() {
      const message = document.getElementById('message-input').value.trim();
      if (message) {
        addMessageToChat(message);
        socket.emit('message', message);
        document.getElementById('message-input').value = '';
      }
    }

    function toggleTheme() {
      const isDarkMode = bodyElement.classList.toggle('dark-theme');
      themeToggleButton.textContent = isDarkMode ? 'Light' : 'Dark';
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    function restoreTheme() {
      if (localStorage.getItem('theme') === 'dark') {
        bodyElement.classList.add('dark-theme');
        themeToggleButton.textContent = 'Light';
      }
    }

    function updateDateTime() {
      const datetimeElement = document.getElementById('datetime');
      const now = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      };
      datetimeElement.textContent = now.toLocaleDateString('de-DE', options);
    }

    // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    init();
    setInterval(updateDateTime, 1000);
    updateDateTime();
  </script>
</body>
</html>